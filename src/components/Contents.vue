<template>
  <v-layout column>
    <vue-element-loading :active="loading" spinner="bar-fade-scale" color="#3A8FCA" is-full-screen />
    <EvaluationTitle :stage="currentStage" :tasks="tasks" :studentInfo="studentInfo" />

    <EvaluationTasks
      :stage="currentStage"
      :task="tasks[currentStage - 1]"
      v-on:collectAnswers="answerCollector"
      ref="evaluationTasks"
    />

    <v-layout id="nav-buttons">
      <v-spacer />
      <v-btn id="next-item-btn" color="primary" round large depressed @click="nextTaskOnClick">
        <span>下一步</span>
        <v-icon dark right>navigate_next</v-icon>
      </v-btn>
    </v-layout>

    <v-snackbar v-model="showNextTaskSnackbar" top color="primary">
      <v-progress-circular :size="20" v-model="countdownProgress"></v-progress-circular>
      <span id="snackbarInfo">你确定要进行下一项评教吗？</span>
      <v-btn flat @click="nextTaskFinalConfirm">是的</v-btn>
    </v-snackbar>

    <v-snackbar v-model="showUncompletedWarning" top color="error">
      <v-icon dark :size="20">error</v-icon>
      <span id="snackbarInfo">你有未回答的题目，请将全部问题回答完整。</span>
      <v-btn flat @click="closeUncompletedWarning">好的</v-btn>
    </v-snackbar>

    <v-snackbar v-model="showEvaluatedWarning" top color="error">
      <v-icon dark :size="20">error</v-icon>
      <span id="snackbarInfo">本节课程你已评价，将直接进入下一部分评教任务。</span>
      <v-btn flat @click="closeEvaluatedWarning">好的</v-btn>
    </v-snackbar>

    <v-snackbar v-model="showCompletedAllSnackbar" top color="success">
      <v-progress-circular :size="20" v-model="countdownProgress"></v-progress-circular>
      <span id="snackbarInfo">全部评教任务已经完成，确认提交结果？</span>
      <v-btn flat @click="submitTaskFinalConfirm">确认</v-btn>
    </v-snackbar>
  </v-layout>
</template>

<script>
import EvaluationTitle from '@/components/EvaluationTitle'
import EvaluationTasks from '@/components/EvaluationTasks'

import Cookies from 'js-cookie'
import worker from 'workerize-loader!./../credentials'

export default {
  name: 'Contents',
  components: {
    EvaluationTitle,
    EvaluationTasks
  },
  props: {
    tasks: Array,
    studentInfo: Object
  },
  data() {
    return {
      showNextTaskSnackbar: false,
      showCompletedAllSnackbar: false,
      showUncompletedWarning: false,
      showEvaluatedWarning: false,

      loading: false,

      countdownProgress: 100,
      timeoutId: null,

      currentStage: 1,

      currentAnswerList: Object,

      rynmParams: {
        gamma:
          '76082481189518171659618347271359316061974334924246135550677426868159186269917',
        g:
          '14324589826880501450566120667645878869223081658493572976099532413757027896194',
        rho:
          '14952013069126470028876872236652170302350646862625615129237430316253689',
        exp: '5088444'
      }
    }
  },
  mounted() {
    // TODO: get signature, uk and public key from localStorage (or AIP)
    let seed = {
      // Signature: (s, e, v)
      signature: {
        s:
          '7657736367123126110017127553786881824168870826299145547627258012329428880945602001563399023126163490001035569727950560075058778804790351137001712263142470703984872264768906652932977841162313917182104719493295967517143305944260227386988707163569394907485592697836673001728797545591777890525603060346507567749449499723487986342558046966002986184600112858908729337735167794574264483516934782064474381000244780039816660402606218729886654373878060799052236295651425986366345619949129119198301900061108045769697254993071678362310117155528361333139530892343496458091717723803376492495224666551660986831494392603146637066401653373727474092032424343639693636338572434987652161422584195471164276684156892270378112013894499721671694336204829478325390333325549105645594718976302698101890275355513049052883923887981978811610228997580407653491767144844371683658444118417860326354119637398152195131856671624995365286811266570732282009248052823541625100274641042942092215184351021596706007472738614988734903836566569786273521570880129787112525687689414446773881509646479375848284774544858270022739743302425354083950174327202350514056813653754827233700694231534901786791694046352229206150714232070502227250262377975895506828238908378984667340154002550707412394339800790162353746096394709514161230149958419835714325040443836495010505510648507284683174940602745321999694275798275204380369943487443279523550613620669346263724416661739965383091398891329779095337671427137227670574567093235869062936403370666341509889064655508908575049393293269307822125762981291242472475997640296161548112423156953031195354342209943382965572624502781206613131697423107033821111937013237004380256494085141270608005229810849687490623134188163733066786370819622106462525803600709111652472094601887793226398643737135126673991808552723329735863944186829058781825507870778683883651960838862210365769911234299063348189357397092688425391873710611317801976758146747841394584072604244439287650833363089275949907131265474384187937384394740460036933094716345634670138200036105973377506411546054702588406557837265333309674285284120441735572045369416190696913139791662935378289273175906155544085008499893533431893039198378636061948721420172857378900693457547871232440228021441795853638011004350020534472800492450159096792506735377848782504227845345531529348464006508789231323757476139619606662962196638732710226322562300487011348158573091269534688366242302025870663782317158453786172047898782689345270855559700118274441',
        e:
          '108234370253725698326920036124757031945859376526115783118524878432769504937956473104059859006849666989360785497222967761866067548048745756893930782139609505593371569915295906081992141241177300684579992118438976279292732152492496570108622341717404844726363385598314284101872197646028261787178025088968448076639310378591385717767256580702668664751658161811528764662358401898576262830107974284065807440676685507683080502846690857960999082171246375018670620317070400568326095262979653134548323675445403440562729966723500779023855022411719878414058473067159334998252353757025179851732861380513492113289291284992401694555149',
        v:
          '128756547632231014754510681776773938657540289002881293974268059553981191768060552310924272523476175331116925997331607960251277778191047055501982722950141645674538129526351008486418822307846990185096240200218241133772484965360832117596536899533984031917799509006593444528502056516725519630246534849765550453301705092435595739266884697559294999263186617772827473862367024462633109987490140650278402172881766031530149520505671501104992557792339347670330791448747148963395970485924357636992648613208824395373761939333237846827840402096658852156649870104679417337693410145328027633998507793752311364099470501667827021037717413086439431397353939862417073391571689789955679780607472066849827441647635010481301831900375501700415723032047092223250783488846489805363296496676874001083961568107207432365566743324367678136670835004302983478964077603363163338379157519174849050169936653475435716652852974905437690083344531416807730540547670563653803986195511466240782499103929875988590143638881271239480093518347583520489671724939491810603387031271061825138035374062418107515895929424821509975049886463412275726012433622981445020745504817818267953110508551298038022105818108020037473878991375142028575600729753910277226709328528490888610552055306'
      },
      // Message: uk
      uk: '39221',
      // Public key
      pubkey: {
        n:
          '995322805979515834558343468842916180759398735836299642552671277553436605924676002587953511055380189928226375717433917124717908984708606305374032958626554958860909453278783458873306469241244675641365366036514899211875662732509935026648241060520219051521771208017390043986553108598550724072453379477936010566711782041018386220545670193867667919597191273018006880114409775884425240030640659562023006561989146492869210993283887178327183532449477268194712946509715791807615817143939380025007100686067465112278249997157932908876612640941502811186133613668119809840083468471542466139288449635577852164455413746094670350703522699726415589809054462751812570094092751723129609967520463224530348385723535638257968207377103810611269636899915323567881579002268612467803894138380778261525446973153523205937247721136041308068326109914765891224601178223715212135637444748792240096445062639720393786910047718144696810078421071820451081219770308784702534795037936119002778734604013518410242339818832165649911205568297863193799237485570149063423545549483448556190702405905404181393026850748272840861267532602816537334579644915357133405263405757166158992252648721136637621788073868968553137689795416175423960523662971891729651267346627791485749869711443',
        a:
          '12087411521712884230548818932215849915230693065039797732079564198974892862597831109952534077668332643422074158482573732210162273511553665928073726857702557181532656284755210457719371511428101155780356008752425295592824942585276622030008447120971014786632830611193537954352443677531942547872959930513777786107406426542695577986048441822499901134217943076792295594037884535736168807745153656459836503075980912522491314057122456046657116758732006466896814708413871176381538974032518089022453265341233558920419342470261993217488003652157418418014185031499816230354904837843025386687622526310803915419536507409000051075609',
        b:
          '2242270542618448865314559768022100722842570567056924045921386527068339890312069016915455607823684996518941546805310979946701951045890940223094847042228045197340068854071808813643399366076303642309446375377852951266210119887535655542203198741044381532149819298438455894694068472282714459161981921663456731501364545269170188180702140156122178514295944916099375760015071778556315387790506727099991721489671311421671663831332164661445554395491222541225826729390422552293214145097480372858790808600875996573542654224130516646000702896367211682871372098287864227008583484451059672114799718269165603918369004881137307238801',
        c:
          '3847486758243159796895515172456640774238377364207114361071125832899764651849170432345428382841393288105544368133028326434962386649917303953066882299219846125243193404409271954822912465878473288879534414288968728918421955499219107182879335153167910469202674005356189048129023288961608631689799460018567408759115342151784370611824231381685407114183926690312525920769115326113770148573926566857407810445120613989443722658330980493935674273031069032149428145389429503396877464994735840952053414199033745730835357940182948896187316765028005120608327244164393836638867641889517970172625781275092570385942804154408782470404',
        g:
          '79694902543738067551569976442969319157658019824384177227697418677955952659774934227050618422966369755344387672958948475697938524471446831922467840437100908707176735894243192411216027732827007061088352261403538026570676397115572002177952579837870853804728089491969851759848647507798224265643108713502271580000225989965230318002488650389878212790775040363567574248704803977378681418421239485699611716709560459011711786402127371191998501459125059706159553864562266401570005849735513443117253160038972164943729421750058017930976637975056919876324187250639458986023466523048333683864079354987625844974359715260665263171705642126352837826511427911122146256409004974013398174475162417012630982051881206119865710800077884329158126259551172451011191286688127719181169155785274421145395273721516526482979092813639555396638286588447369069562536711929150977281360706436723437702802438016012465402942356823014553614221930481531640409796005442620078985607686920544233588362683411619797733875307301960848370977120348813068208389799556865364779562321686205409481124867527508171014542386935301845256634029160723354310753383710435856172469995168262514962659498801439387296050495937425525648384462027253163340768389096813054896052840494598577791933804',
        h:
          '14278136476795606093042578702252138383567207660664827197503882837252436020330007573428221010226768924354544728409096950571644623349974331458917210692824944190393686822298809384473072813435484606643889635889639325577412887697019292795500378574036177872816107205922502330189636993674716615204444170097570787865643325103401147525719449566644178816283391334442312995721152436591738178660454319028328401766191414756526796863716097652667483607007870212638826452652070817603293076068105425120980818601086921188668887170846665970718173330136851886359892816611477820696787791870189922552880276262068517345562669130128349115225'
      }
    }
    localStorage.setItem('seed', JSON.stringify(seed))
  },
  methods: {
    /**
     * setSnackbarCountdown
     * * Count down for snackbar notification, 6 seconds
     */
    setSnackbarCountdown(timeLeft, timeTotal) {
      this.countdownProgress = (timeLeft * 100) / timeTotal
      if (timeLeft > 0) {
        this.timeoutId = setTimeout(() => {
          this.setSnackbarCountdown(timeLeft - 300, timeTotal)
        }, 300) //! Update progress every 0.3 seconds.
      }
    },

    /**
     * answerCollector(answerList)
     * * Collect answers from component `EvaluationTasks.vue`
     * @param answerList
     */
    answerCollector(answerList) {
      this.currentAnswerList = answerList
    },

    /**
     * nextTaskOnClick()
     * * Show snackbar and double confirmation button
     */
    nextTaskOnClick() {
      let totalTasks = this.tasks.length

      if (this.currentStage < totalTasks) {
        this.showNextTaskSnackbar = true
      } else {
        this.showCompletedAllSnackbar = true
      }
      let countdownTime = 6 * 1000 // 6 seconds
      this.setSnackbarCountdown(countdownTime, countdownTime)
    },

    /**
     * nextTaskFinalConfirm()
     * * Final confirmation button, authenticates and proceed to next task
     */
    nextTaskFinalConfirm() {
      this.$refs.evaluationTasks.getAnswers()

      clearTimeout(this.timeoutId)
      this.showNextTaskSnackbar = false

      if (this.currentAnswerList === 'undone') {
        this.showUncompletedWarning = true
      } else {
        // Set loading animations
        this.loading = true

        // * Authenticate user
        this.genCredentials()
          .then(credentials => {
            let rnym = credentials['rnym']
            let currentCourseId = this.tasks[this.currentStage - 1].id

            let csrftoken = Cookies.get('csrftoken')

            let api = '/api/v1/auth'
            this.$http({
              method: 'post',
              url: api,
              headers: {
                'X-CSRFToken': csrftoken
              },
              params: {
                course_no: currentCourseId,
                classno: this.studentInfo.class
              },
              data: {
                credentials: credentials
              }
            })
              .then(resp => {
                if (resp.data.status === 'accept') {
                  // * Submit results
                  this.submitAnswers(rnym)
                    .then(() => {
                      this.tasks[this.currentStage - 1].status = 1
                      this.currentStage = this.currentStage + 1

                      this.loading = false
                      // Back to top
                      this.$vuetify.goTo(0)
                    })
                    .catch(err => {
                      // eslint-disable-next-line no-console
                      console.log('Submit answers failed: ', err)
                      this.loading = false
                      this.$router.push({ path: '/denied' })
                    })
                } else if (resp.data.status === 'evaluated') {
                  this.showEvaluatedWarning = true
                  // Proceed to next stage directly
                  this.tasks[this.currentStage - 1].status = 1
                  this.currentStage = this.currentStage + 1

                  this.loading = false
                  // Back to top
                  this.$vuetify.goTo(0)
                } else {
                  this.loading = false
                  this.$router.push({ path: '/denied' })
                }
              })
              .catch(err => {
                // eslint-disable-next-line no-console
                console.log('Auth error: ', err)
                this.loading = false
                this.$router.push({ path: '/denied' })
              })
          })
          .catch(err => {
            // eslint-disable-next-line no-console
            console.log('Credential generation failed: ', err)
            this.loading = false
          })
      }
    },

    /**
     * submitTaskFinalConfirm()
     * * Final submit confirmation
     */
    submitTaskFinalConfirm() {
      this.$refs.evaluationTasks.getAnswers()

      clearTimeout(this.timeoutId)
      this.showCompletedAllSnackbar = false

      if (this.currentAnswerList === 'undone') {
        this.showUncompletedWarning = true
      } else {
        this.loading = true

        // * Authenticate user
        this.genCredentials().then(credentials => {
          let rnym = credentials['rnym']
          let currentCourseId = this.tasks[this.currentStage - 1].id
          let csrftoken = Cookies.get('csrftoken')

          let api = '/api/v1/auth'
          this.$http({
            method: 'post',
            url: api,
            headers: {
              'X-CSRFToken': csrftoken
            },
            params: {
              course_no: currentCourseId,
              classno: this.studentInfo.class
            },
            data: {
              credentials: credentials
            }
          })
            .then(resp => {
              // eslint-disable-next-line no-console
              console.log('Auth resp: ', resp.data)

              if (resp.data.status === 'accept') {
                // * Submit results
                this.submitAnswers(rnym)
                  .then(() => {
                    this.tasks[this.currentStage - 1].status = 1

                    this.loading = false
                    this.$router.push({ path: '/success' })
                  })
                  .catch(err => {
                    // eslint-disable-next-line no-console
                    console.log('Submit answers failed: ', err)
                    this.loading = false
                    this.$router.push({ path: '/denied' })
                  })
              } else if (resp.data.status === 'evaluated') {
                this.tasks[this.currentStage - 1].status = 1

                this.loading = false
                this.$router.push({ path: '/success' })
              } else {
                this.loading = false
                this.$router.push({ path: '/denied' })
              }
            })
            .catch(err => {
              // eslint-disable-next-line no-console
              console.log('Auth error: ', err)
              this.loading = false
              this.$router.push({ path: '/denied' })
            })
        })
      }
    },

    /**
     * submitAnswers()
     * * Submit answers to backend
     */
    submitAnswers(rnym) {
      let currentCourseId = this.tasks[this.currentStage - 1].id
      let csrftoken = Cookies.get('csrftoken')

      let api = '/api/v1/result'
      return this.$http({
        method: 'post',
        url: api,
        headers: {
          'X-CSRFToken': csrftoken
        },
        params: {
          course_no: currentCourseId,
          classno: this.studentInfo.class
        },
        data: {
          rnym: rnym,
          result: this.currentAnswerList
        }
      })
    },

    closeUncompletedWarning() {
      this.showUncompletedWarning = false
    },
    closeEvaluatedWarning() {
      this.showEvaluatedWarning = false
    },

    /**
     * genCredentials()
     * * Generate credentials for backend to authenticate
     */
    genCredentials() {
      // Get seed from localStorage
      let seed = localStorage.seed
      let currentCourseId = this.tasks[this.currentStage - 1].id
      let rynmParams = this.rynmParams

      let credentialWorker = worker()
      return credentialWorker.generate(seed, currentCourseId, rynmParams)
    }
  }
}
</script>

<style>
#next-item-btn {
  font-weight: 700;
}
#nav-buttons {
  margin-right: 30px;
  margin-bottom: 30px;
}
#snackbarInfo {
  margin-left: 20px;
}
</style>
